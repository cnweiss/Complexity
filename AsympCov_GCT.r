#Simulation-based estimation of asymptotic covariance of OP frequencies

#All possible SOPs:
getPerms <- function(x) {
    if (length(x) == 1) {
        return(x)
    }
    else {
        res <- matrix(nrow = 0, ncol = length(x))
        for (i in seq_along(x)) {
            res <- rbind(res, cbind(x[i], Recall(x[-i])))
        }
        return(res)
    }
}









########################
#Simulation experiments:
########################

d <- 1 #only delay 1

m <- 3
mfak <- factorial(m)

# getPerms(1:m)
     # [,1] [,2] [,3]
# [1,]    1    2    3
# [2,]    1    3    2
# [3,]    2    1    3
# [4,]    2    3    1
# [5,]    3    1    2
# [6,]    3    2    1



#Lexicographic arrangement as in manuscript:
Sm <- getPerms(1:m)
np <- dim(Sm)[1]

#Same as vector of strings:
sSm <- apply(Sm, 1, function(x) paste(x, collapse=""))
#sSm
#"123" "132" "213" "231" "312" "321"




#Example models

#coint tossing



#one very long time series:
T <- 1e8 + m-1 

set.seed(123)


n <- T-(m-1)*d




#############################################
#Separate simulation of coin-tossing process:
#############################################

datanum <- rep(NA, n)

#First OP:
c21 <- rbinom(1,1,0.5) #0: 1<2, and 1: 1>2
c32 <- rbinom(1,1,0.5)
#ct075:
# c21 <- rbinom(1,1,0.25) #0: 1<2, and 1: 1>2
# c32 <- rbinom(1,1,0.25)
#ct025:
# c21 <- rbinom(1,1,0.75) #0: 1<2, and 1: 1>2
# c32 <- rbinom(1,1,0.75)

#"123" "132" "213" "231" "312" "321"
if(c21==c32){
	if(c21==0 & c32==0){ #1<2<3, so 123
		datanum[1]=1
	} 
	if(c21==1 & c32==1){ #1>2>3, so 321
		datanum[1]=6
	}
}else{
	c31 <- rbinom(1,1,0.5)
	# c31 <- rbinom(1,1,0.25)
	# c31 <- rbinom(1,1,0.75)

	if(c21==0 & c32==1 & c31==0){ #1<2 2>3 1<3, so 132
		datanum[1]=2
	} 
	if(c21==0 & c32==1 & c31==1){ #1<2 2>3 1>3, so 231
		datanum[1]=4
	} 
	if(c21==1 & c32==0 & c31==0){ #1>2 2<3 1<3, so 213
		datanum[1]=3
	}
	if(c21==1 & c32==0 & c31==1){ #1>2 2<3 1>3, so 312
		datanum[1]=5
	}
}


#Remaining OPs:
for(t in 2:n){
	c21 <- c32
	c32 <- rbinom(1,1,0.5)
	# c32 <- rbinom(1,1,0.25)
	# c32 <- rbinom(1,1,0.75)

	#"123" "132" "213" "231" "312" "321"
	if(c21==c32){
		if(c21==0 & c32==0){ #1<2<3, so 123
			datanum[t]=1
		} 
		if(c21==1 & c32==1){ #1>2>3, so 321
			datanum[t]=6
		}
	}else{
		c31 <- rbinom(1,1,0.5)
		# c31 <- rbinom(1,1,0.25)
		# c31 <- rbinom(1,1,0.75)

		if(c21==0 & c32==1 & c31==0){ #1<2 2>3 1<3, so 132
			datanum[t]=2
		} 
		if(c21==0 & c32==1 & c31==1){ #1<2 2>3 1>3, so 231
			datanum[t]=4
		} 
		if(c21==1 & c32==0 & c31==0){ #1>2 2<3 1<3, so 213
			datanum[t]=3
		}
		if(c21==1 & c32==0 & c31==1){ #1>2 2<3 1>3, so 312
			datanum[t]=5
		}
	}
} #for t




#Binarization:
bincodes <- diag(1,np)
databin <- bincodes[datanum,] #assign row vectors


hatp <- colMeans(databin)
hatp
#coin tossing: 0.2500130 0.1249771 0.1249809 0.1250248 0.1250209 0.2499834
#coin tossing 0.25: 0.06249224 0.04688546 0.04690183 0.14062459 0.14060822 0.56248766
#coin tossing 0.75: 0.56248766 0.14060822 0.14062459 0.04690183 0.04688546 0.06249224


#Covariance estimation like in Newey87:
# upper <- floor(n^(1/5)) #Newey87
upper <- floor(0.75*n^(1/3)) #Lazarus18, "textbook choice"
upper #39 348

#Bartlett kernel:
weight <- 1-(1:upper)/upper

covs <- acf(databin, type="covariance", plot=FALSE, lag.max=upper)$acf

OPcov.est <- covs[1,,]
for(k in 1:upper){
	OPcov.est <- OPcov.est + weight[k] * (covs[k+1,,] + t(covs[k+1,,]))
}
OPcov.est

#coin tossing: 

            # [,1]        [,2]        [,3]        [,4]        [,5]        [,6]
# [1,]  0.31365815 -0.03123429 -0.03139884 -0.03150092 -0.03133595 -0.18818815
# [2,] -0.03123429  0.07800873  0.01563039 -0.04661409  0.01540517 -0.03119591
# [3,] -0.03139884  0.01563039  0.07793444  0.01537702 -0.04656651 -0.03097650
# [4,] -0.03150092 -0.04661409  0.01537702  0.07809756  0.01574681 -0.03110638
# [5,] -0.03133595  0.01540517 -0.04656651  0.01574681  0.07807586 -0.03132538
# [6,] -0.18818815 -0.03119591 -0.03097650 -0.03110638 -0.03132538  0.31279232


#coin tossing 0.25: 

             # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.082141487  0.002827817  0.002785955  0.008842053  0.008883158 -0.10548047
# [2,]  0.002827817  0.040228531  0.005026345 -0.019813587  0.015253787 -0.04352289
# [3,]  0.002785955  0.005026345  0.040194016  0.015284206 -0.019749263 -0.04354126
# [4,]  0.008842053 -0.019813587  0.015284206  0.081417147  0.045916200 -0.13164602
# [5,]  0.008883158  0.015253787 -0.019749263  0.045916200  0.081324550 -0.13162843
# [6,] -0.105480469 -0.043522893 -0.043541258 -0.131646019 -0.131628432  0.45581907


#coin tossing 0.75: 

            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.45667926 -0.131738399 -0.132096490 -0.043912770 -0.043553465 -0.105378139
# [2,] -0.131  0.00862670373840  0.081669784  0.046163851 -0.019911600  0.015189660
# [3,] -0.13209649  0.046163851  0.081617169  0.015232494 -0.019817671  0.008900647
# [4,] -0.04391277 -0.019911600  0.015232494  0.040371814  0.005092324  0.003127739
# [5,] -0.04355346  0.015189660 -0.019817671  0.005092324  0.040234128  0.002855025
# [6,] -0.10537814  0.008626703  0.008900647  0.003127739  0.002855025  0.081868026



#without weighting:

OPcov.est <- covs[1,,]
for(k in 1:upper){
	OPcov.est <- OPcov.est + covs[k+1,,] + t(covs[k+1,,])
}
OPcov.est

#coin tossing: 
            # [,1]        [,2]        [,3]        [,4]        [,5]        [,6]
# [1,]  0.31273691 -0.03117586 -0.03140264 -0.03130858 -0.03107710 -0.18777273
# [2,] -0.03117586  0.07800924  0.01560235 -0.04678821  0.01563201 -0.03127953
# [3,] -0.03140264  0.01560235  0.07801028  0.01559403 -0.04681720 -0.03098681
# [4,] -0.03130858 -0.04678821  0.01559403  0.07797416  0.01560481 -0.03107620
# [5,] -0.03107710  0.01563201 -0.04681720  0.01560481  0.07802173 -0.03136425
# [6,] -0.18777273 -0.03127953 -0.03098681 -0.03107620 -0.03136425  0.31247952

            # [,1]        [,2]        [,3]        [,4]        [,5]        [,6]
# [1,]  0.31450809 -0.03128569 -0.03131158 -0.03140686 -0.03139631 -0.18910764
# [2,] -0.03128569  0.07814713  0.01580278 -0.04685016  0.01550809 -0.03132215
# [3,] -0.03131158  0.01580278  0.07753259  0.01526414 -0.04645319 -0.03083474
# [4,] -0.03140686 -0.04685016  0.01526414  0.07804170  0.01593445 -0.03098327
# [5,] -0.03139631  0.01550809 -0.04645319  0.01593445  0.07789290 -0.03148593
# [6,] -0.18910764 -0.03132215 -0.03083474 -0.03098327 -0.03148593  0.31373373


#coin tossing 0.25: 
             # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.081994236  0.002887862  0.002971899  0.008765512  0.008693515 -0.10531302
# [2,]  0.002887862  0.040239177  0.005142878 -0.019779532  0.015296377 -0.04378676
# [3,]  0.002971899  0.005142878  0.040346489  0.015388184 -0.019829316 -0.04402013
# [4,]  0.008765512 -0.019779532  0.015388184  0.081275689  0.046120704 -0.13177056
# [5,]  0.008693515  0.015296377 -0.019829316  0.046120704  0.081243868 -0.13152515
# [6,] -0.105313023 -0.043786762 -0.044020135 -0.131770558 -0.131525150  0.45641563

             # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.082199082  0.002865152  0.002776688  0.008975286  0.009039838 -0.10585605
# [2,]  0.002865152  0.040075228  0.005018285 -0.019861695  0.015192923 -0.04328989
# [3,]  0.002776688  0.005018285  0.040066655  0.015258812 -0.019770032 -0.04335041
# [4,]  0.008975286 -0.019861695  0.015258812  0.081237934  0.046122783 -0.13173312
# [5,]  0.009039838  0.015192923 -0.019770032  0.046122783  0.081111065 -0.13169658
# [6,] -0.105856045 -0.043289893 -0.043350408 -0.131733120 -0.131696577  0.45592604


#coin tossing 0.75: 
            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.45641563 -0.131525150 -0.131770558 -0.044020135 -0.043786762 -0.105313023
# [2,] -0.13152515  0.081243868  0.046120704 -0.019829316  0.015296377  0.008693515
# [3,] -0.13177056  0.046120704  0.081275689  0.015388184 -0.019779532  0.008765512
# [4,] -0.04402013 -0.019829316  0.015388184  0.040346489  0.005142878  0.002971899
# [5,] -0.04378676  0.015296377 -0.019779532  0.005142878  0.040239177  0.002887862
# [6,] -0.10531302  0.008693515  0.008765512  0.002971899  0.002887862  0.081994236

            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.45840441 -0.132313910 -0.132760988 -0.044028674 -0.043585057 -0.105715781
# [2,] -0.13231391  0.081890400  0.046501774 -0.020079221  0.015319972  0.008680985
# [3,] -0.13276099  0.046501774  0.081852892  0.015313444 -0.020050456  0.009143334
# [4,] -0.04402867 -0.020079221  0.015313444  0.040443343  0.005069217  0.003281890
# [5,] -0.04358506  0.015319972 -0.020050456  0.005069217  0.040430255  0.002816069
# [6,] -0.10571578  0.008680985  0.009143334  0.003281890  0.002816069  0.081793503





#For comparison, some known covariance matrices:

Sigma.ct <- 1/64 * rbind(c(20, -2, -2, -2, -2, -12),
c(-2, 5, 1, -3, 1, -2),
c(-2, 1, 5, 1, -3, -2),
c(-2, -3, 1, 5, 1, -2),
c(-2, 1, -3, 1, 5, -2),
c(-12, -2, -2, -2, -2, 20)) 
Sigma.ct
         # [,1]      [,2]      [,3]      [,4]      [,5]     [,6]
# [1,]  0.31250 -0.031250 -0.031250 -0.031250 -0.031250 -0.18750
# [2,] -0.03125  0.078125  0.015625 -0.046875  0.015625 -0.03125
# [3,] -0.03125  0.015625  0.078125  0.015625 -0.046875 -0.03125
# [4,] -0.03125 -0.046875  0.015625  0.078125  0.015625 -0.03125
# [5,] -0.03125  0.015625 -0.046875  0.015625  0.078125 -0.03125
# [6,] -0.18750 -0.031250 -0.031250 -0.031250 -0.031250  0.31250

Sigma.ct025 <- rbind(
c(21/256,3/1024,3/1024,9/1024,9/1024,-(27/256)),
c(3/1024,165/4096,21/4096,-(81/4096),63/4096,-(45/1024)),
c(3/1024,21/4096,165/4096,63/4096,-(81/4096),-(45/1024)),
c(9/1024,-(81/4096),63/4096,333/4096,189/4096,-(135/1024)),
c(9/1024,63/4096,-(81/4096),189/4096,333/4096,-(135/1024)),
c(-(27/256),-(45/1024),-(45/1024),-(135/1024),-(135/1024),117/256)) 
Sigma.ct025
             # [,1]         [,2]         [,3]         [,4]         [,5]        [,6]
# [1,]  0.082031250  0.002929688  0.002929688  0.008789062  0.008789062 -0.10546875
# [2,]  0.002929688  0.040283203  0.005126953 -0.019775391  0.015380859 -0.04394531
# [3,]  0.002929688  0.005126953  0.040283203  0.015380859 -0.019775391 -0.04394531
# [4,]  0.008789062 -0.019775391  0.015380859  0.081298828  0.046142578 -0.13183594
# [5,]  0.008789062  0.015380859 -0.019775391  0.046142578  0.081298828 -0.13183594
# [6,] -0.105468750 -0.043945312 -0.043945312 -0.131835938 -0.131835938  0.45703125

