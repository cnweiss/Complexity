#Simulation-based estimation of asymptotic covariance of OP frequencies

#All possible SOPs:
getPerms <- function(x) {
    if (length(x) == 1) {
        return(x)
    }
    else {
        res <- matrix(nrow = 0, ncol = length(x))
        for (i in seq_along(x)) {
            res <- rbind(res, cbind(x[i], Recall(x[-i])))
        }
        return(res)
    }
}









########################
#Simulation experiments:
########################

d <- 1 #only delay 1

m <- 3
mfak <- factorial(m)

# getPerms(1:m)
     # [,1] [,2] [,3]
# [1,]    1    2    3
# [2,]    1    3    2
# [3,]    2    1    3
# [4,]    2    3    1
# [5,]    3    1    2
# [6,]    3    2    1



#Lexicographic arrangement as in manuscript:
Sm <- getPerms(1:m)
np <- dim(Sm)[1]

#Same as vector of strings:
sSm <- apply(Sm, 1, function(x) paste(x, collapse=""))
#sSm
#"123" "132" "213" "231" "312" "321"




#Example models

#iid

#Gaussian RW

#Gauß QMA(1)
bet <- 0.8

#Gauß AR(1)
al <- 0.5

#TEAR(1) parameter:
prerun <- 100
ea1 <- 0.15



#one very long time series:
T <- 1e8 + m-1 

set.seed(123)

#iid
data <- rnorm(T)

#GRW
# data <- cumsum(rnorm(T))


#AR(1)
# data <- arima.sim(n=T, list(ar=c(al), ma=c()))

#QMA(1)
# data <- rnorm(T+1)
# data <- data[-1]+bet*data[1:T]^2

#TEAR(1)
# eps <- rexp(prerun, 1)
# tabR <- rbinom(prerun, 1, ea1)
# X <- 1
# for(t in 1:prerun) X <- (1-ea1)*eps[t] + tabR[t]*X

# eps <- rexp(T, 1)
# tabR <- rbinom(T, 1, ea1)
# data <- rep(NA, T)
# for(t in 1:T){
	# X <- (1-ea1)*eps[t] + tabR[t]*X
	# data[t] <- X
# }



n <- T-(m-1)*d

data0 <- data[1:n]
for(k in 1:(m-1)){
	data0 <- cbind(data0, data[(k*d+1):(k*d+n)])
}

#Generate ordinal patterns as rank vectors:
opts <- t(matrix(c(apply(data0, 1, rank, ties.method="first")), nrow=m))

#transform into vector of strings:
sopts <- apply(opts, 1, function(x) paste(x, collapse=""))

#So sopts is categorical time series with range sSm.

#Numeric coding by 1-m!:
datanum <- match(sopts, sSm)


#Binarization:
bincodes <- diag(1,np)
databin <- bincodes[datanum,] #assign row vectors


hatp <- colMeans(databin)
hatp
#iid: 0.1667497 0.1666255 0.1666194 0.1666556 0.1666617 0.1666881
#GRW: 0.2500543 0.1250433 0.1250140 0.1249339 0.1249633 0.2499912
#AR(1): 0.2097966 0.1451043 0.1450762 0.1450756 0.1451037 0.2098436
#QMA(1): 0.1497114 0.1703682 0.1799197 0.1511151 0.1415636 0.2073220
#TEAR(1): 0.2181201 0.1370422 0.1481593 0.1853791 0.1742620 0.1370372


#Covariance estimation like in Newey87:
# upper <- floor(n^(1/5)) #Newey87
upper <- floor(0.75*n^(1/3)) #Lazarus18, "textbook choice"
upper #39 348

#Bartlett kernel:
weight <- 1-(1:upper)/upper

covs <- acf(databin, type="covariance", plot=FALSE, lag.max=upper)$acf

OPcov.est <- covs[1,,]
for(k in 1:upper){
	OPcov.est <- OPcov.est + weight[k] * (covs[k+1,,] + t(covs[k+1,,]))
}
OPcov.est

#iid: 

            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.12762130 -0.063477879 -0.063647610  0.019163450  0.019332244 -0.03899150
# [2,] -0.06347788  0.077620955  0.027535607 -0.055305012 -0.005578258  0.01920459
# [3,] -0.06364761  0.027535607  0.078004140 -0.005534103 -0.055642933  0.01928490
# [4,]  0.01916345 -0.055305012 -0.005534103  0.077646904  0.027517159 -0.06348840
# [5,]  0.01933224 -0.005578258 -0.055642933  0.027517159  0.077941532 -0.06356974
# [6,] -0.03899150  0.019204588  0.019284899 -0.063488398 -0.063569744  0.12756016



#GRW: 

            # [,1]        [,2]         [,3]         [,4]        [,5]        [,6]
# [1,]  0.31211926 -0.03124029 -0.031291182 -0.031178353 -0.03112829 -0.18728114
# [2,] -0.03124029  0.07808457  0.036031693 -0.046716678 -0.00502337 -0.03113592
# [3,] -0.03129118  0.03603169  0.078123847 -0.005005524 -0.04673821 -0.03112062
# [4,] -0.03117835 -0.04671668 -0.005005524  0.078334885  0.03626575 -0.03170007
# [5,] -0.03112829 -0.00502337 -0.046738212  0.036265745  0.07834030 -0.03171617
# [6,] -0.18728114 -0.03113592 -0.031120623 -0.031700075 -0.03171617  0.31295392


#AR(1): 

            # [,1]          [,2]          [,3]          [,4]          [,5]
# [1,]  0.14240787 -0.0639821707 -0.0641522397  0.0121200008  0.0122899000 -0.03868336
# [2,] -0.06398217  0.0755997581  0.0262085862 -0.0496434741 -0.0006112759  0.01242858
# [3,] -0.06415224  0.0262085862  0.0759867916 -0.0004713671 -0.0498900611  0.01231829
# [4,]  0.01212000 -0.0496434741 -0.0004713671  0.0757450113  0.0262136143 -0.06396379
# [5,]  0.01228990 -0.0006112759 -0.0498900611  0.0262136143  0.0758514524 -0.06385363
# [6,] -0.03868336  0.0124285761  0.0123182898 -0.0639637853 -0.0638536298  0.14175391


#QMA(1): 

            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.13046884 -0.063805893 -0.056115634  0.022821910  0.015121276 -0.04849050
# [2,] -0.06380589  0.075706436  0.024511171 -0.052264282 -0.001396297  0.01724887
# [3,] -0.05611563  0.024511171  0.068849038 -0.004386896 -0.048304720  0.01544704
# [4,]  0.02282191 -0.052264282 -0.004386896  0.074880167  0.026624425 -0.06767532
# [5,]  0.01512128 -0.001396297 -0.048304720  0.026624425  0.073839214 -0.06588390
# [6,] -0.04849050  0.017248866  0.015447040 -0.067675323 -0.065883899  0.14935381


#TEAR(1): 

            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.15813178 -0.073507052 -0.070543020  0.015527780  0.012561688 -0.04217118
# [2,] -0.07350705  0.079417529  0.029402921 -0.051892670 -0.002155108  0.01873438
# [3,] -0.07054302  0.029402921  0.077334402 -0.005205755 -0.052789848  0.02180130
# [4,]  0.01552778 -0.051892670 -0.005205755  0.071024903  0.023903477 -0.05335773
# [5,]  0.01256169 -0.002155108 -0.052789848  0.023903477  0.074906544 -0.05642675
# [6,] -0.04217118  0.018734379  0.021801300 -0.053357735 -0.056426754  0.11141999



#without weighting:

OPcov.est <- covs[1,,]
for(k in 1:upper){
	OPcov.est <- OPcov.est + covs[k+1,,] + t(covs[k+1,,])
}
OPcov.est

#iid: 
            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.12759790 -0.063697992 -0.063918946  0.019367059  0.019601557 -0.03894957
# [2,] -0.06369799  0.077587831  0.027731637 -0.055482023 -0.005622135  0.01948268
# [3,] -0.06391895  0.027731637  0.077889972 -0.005544182 -0.055707921  0.01954944
# [4,]  0.01936706 -0.055482023 -0.005544182  0.077709411  0.027753325 -0.06380359
# [5,]  0.01960156 -0.005622135 -0.055707921  0.027753325  0.077832006 -0.06385683
# [6,] -0.03894957  0.019482682  0.019549439 -0.063803590 -0.063856832  0.12757787

            # [,1]        [,2]         [,3]         [,4]        [,5]        [,6]
# [1,]  0.12723119 -0.06358089 -0.063383468  0.019596109  0.01940606 -0.03926900
# [2,] -0.06358089  0.07750410  0.027408144 -0.055523907 -0.00544596  0.01963851
# [3,] -0.06338347  0.02740814  0.077506472 -0.005441045 -0.05554394  0.01945384
# [4,]  0.01959611 -0.05552391 -0.005441045  0.077559636  0.02752198 -0.06371278
# [5,]  0.01940606 -0.00544596 -0.055543943  0.027521984  0.07758278 -0.06352092
# [6,] -0.03926900  0.01963851  0.019453840 -0.063712777 -0.06352092  0.12741035



#GRW: 
            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.31260526 -0.031162921 -0.030965527 -0.031211584 -0.031407605 -0.18785762
# [2,] -0.03116292  0.077942380  0.036275580 -0.046753021 -0.005081604 -0.03122041
# [3,] -0.03096553  0.036275580  0.078136631 -0.005133036 -0.046987111 -0.03132654
# [4,] -0.03121158 -0.046753021 -0.005133036  0.078024741  0.036386432 -0.03131353
# [5,] -0.03140760 -0.005081604 -0.046987111  0.036386432  0.078295905 -0.03120602
# [6,] -0.18785762 -0.031220413 -0.031326536 -0.031313532 -0.031206017  0.31292412

            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.31262054 -0.031509675 -0.031349030 -0.030916153 -0.031123556 -0.18772213
# [2,] -0.03150968  0.078175021  0.036093639 -0.046950530 -0.004808406 -0.03100005
# [3,] -0.03134903  0.036093639  0.077977475 -0.004864261 -0.046750746 -0.03110708
# [4,] -0.03091615 -0.046950530 -0.004864261  0.078356328  0.036294231 -0.03191962
# [5,] -0.03112356 -0.004808406 -0.046750746  0.036294231  0.078247803 -0.03185933
# [6,] -0.18772213 -0.031000049 -0.031107077 -0.031919616 -0.031859326  0.31360819


#AR(1): 
            # [,1]          [,2]          [,3]          [,4]          [,5]
# [1,]  0.14161298 -0.0640617868 -0.0643022051  0.0123621251  0.0126074150 -0.03821853
# [2,] -0.06406179  0.0752758987  0.0262826263 -0.0495747561 -0.0005891945  0.01266721
# [3,] -0.06430221  0.0262826263  0.0756097312 -0.0004418826 -0.0497559484  0.01260768
# [4,]  0.01236213 -0.0495747561 -0.0004418826  0.0755447333  0.0263871991 -0.06427742
# [5,]  0.01260742 -0.0005891945 -0.0497559484  0.0263871991  0.0755635320 -0.06421300
# [6,] -0.03821853  0.0126672122  0.0126076785 -0.0642774190 -0.0642130033  0.14143406

            # [,1]          [,2]          [,3]          [,4]          [,5]
# [1,]  0.14179371 -0.0643255895 -0.0643948306  0.0125630362  0.0126151323 -0.03825146
# [2,] -0.06432559  0.0753728879  0.0263210601 -0.0495595521 -0.0005080192  0.01269921
# [3,] -0.06439483  0.0263210601  0.0758806212 -0.0004835132 -0.0500201892  0.01269685
# [4,]  0.01256304 -0.0495595521 -0.0004835132  0.0753193219  0.0262808482 -0.06412014
# [5,]  0.01261513 -0.0005080192 -0.0500201892  0.0262808482  0.0757671530 -0.06413493
# [6,] -0.03825146  0.0126992125  0.0126968516 -0.0641201412 -0.0641349252  0.14111046


#QMA(1): 
            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.13004543 -0.063685709 -0.056229438  0.022764789  0.015323891 -0.04821897
# [2,] -0.06368571  0.075409161  0.024636227 -0.052176047 -0.001401811  0.01721818
# [3,] -0.05622944  0.024636227  0.068548997 -0.004341337 -0.048295022  0.01568057
# [4,]  0.02276479 -0.052176047 -0.004341337  0.074607919  0.026745442 -0.06760077
# [5,]  0.01532389 -0.001401811 -0.048295022  0.026745442  0.073675353 -0.06604785
# [6,] -0.04821897  0.017218179  0.015680572 -0.067600767 -0.066047853  0.14896883

            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.13044759 -0.064065542 -0.056243730  0.023077265  0.015244612 -0.04846020
# [2,] -0.06406554  0.075658195  0.024637898 -0.052468958 -0.001381058  0.01761947
# [3,] -0.05624373  0.024637898  0.068595981 -0.004297798 -0.048303475  0.01561112
# [4,]  0.02307726 -0.052468958 -0.004297798  0.074813129  0.026624824 -0.06774846
# [5,]  0.01524461 -0.001381058 -0.048303475  0.026624824  0.073566022 -0.06575093
# [6,] -0.04846020  0.017619465  0.015611124 -0.067748461 -0.065750926  0.14872900


#TEAR(1): 
            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.15799364 -0.073925734 -0.070799212  0.015891242  0.012776410 -0.04193635
# [2,] -0.07392573  0.079528497  0.029517260 -0.052013266 -0.002025349  0.01891859
# [3,] -0.07079921  0.029517260  0.077271606 -0.005071485 -0.052829171  0.02191100
# [4,]  0.01589124 -0.052013266 -0.005071485  0.070896386  0.023969594 -0.05367247
# [5,]  0.01277641 -0.002025349 -0.052829171  0.023969594  0.074761706 -0.05665319
# [6,] -0.04193635  0.018918592  0.021911002 -0.053672471 -0.056653191  0.11143242

            # [,1]         [,2]         [,3]         [,4]         [,5]
# [1,]  0.15779552 -0.073585588 -0.070623409  0.015760362  0.012783788 -0.04213068
# [2,] -0.07358559  0.079136934  0.029460855 -0.051752128 -0.002112683  0.01885261
# [3,] -0.07062341  0.029460855  0.076975176 -0.005165217 -0.052678210  0.02203080
# [4,]  0.01576036 -0.051752128 -0.005165217  0.070554990  0.023984462 -0.05338247
# [5,]  0.01278379 -0.002112683 -0.052678210  0.023984462  0.074597830 -0.05657519
# [6,] -0.04213068  0.018852610  0.022030804 -0.053382471 -0.056575187  0.11120492






#For comparison, some known covariance matrices:
Sigma.iid <- 1/360 * rbind(c(46,-23,-23,7,7,-14),
c(-23,28,10,-20,-2,7),
c(-23,10,28,-2,-20,7),
c(7,-20,-2,28,10,-23),
c(7,-2,-20,10,28,-23),
c(-14,7,7,-23,-23,46))
Sigma.iid
            # [,1]         [,2]         [,3]         [,4]         [,5]        [,6]
# [1,]  0.12777778 -0.063888889 -0.063888889  0.019444444  0.019444444 -0.03888889
# [2,] -0.06388889  0.077777778  0.027777778 -0.055555556 -0.005555556  0.01944444
# [3,] -0.06388889  0.027777778  0.077777778 -0.005555556 -0.055555556  0.01944444
# [4,]  0.01944444 -0.055555556 -0.005555556  0.077777778  0.027777778 -0.06388889
# [5,]  0.01944444 -0.005555556 -0.055555556  0.027777778  0.077777778 -0.06388889
# [6,] -0.03888889  0.019444444  0.019444444 -0.063888889 -0.063888889  0.12777778

Sigma.grw <- 1/192 * rbind(c(60, -6, -6, -6, -6, -36),
c(-6, 15, 7, -9, -1, -6),
c(-6, 7, 15, -1, -9, -6),
c(-6, -9, -1, 15, 7, -6),
c(-6, -1, -9, 7, 15, -6),
c(-36, -6, -6, -6, -6, 60))
Sigma.grw
         # [,1]         [,2]         [,3]         [,4]         [,5]     [,6]
# [1,]  0.31250 -0.031250000 -0.031250000 -0.031250000 -0.031250000 -0.18750
# [2,] -0.03125  0.078125000  0.036458333 -0.046875000 -0.005208333 -0.03125
# [3,] -0.03125  0.036458333  0.078125000 -0.005208333 -0.046875000 -0.03125
# [4,] -0.03125 -0.046875000 -0.005208333  0.078125000  0.036458333 -0.03125
# [5,] -0.03125 -0.005208333 -0.046875000  0.036458333  0.078125000 -0.03125
# [6,] -0.18750 -0.031250000 -0.031250000 -0.031250000 -0.031250000  0.31250
